#!/usr/bin/env python3
import argparse
import json
import os

from firm import firm

DESCRIPTION = """firm-findmotifs - FIRM find motifs for miRvestigator"""

if __name__ == '__main__':
    parser = argparse.ArgumentParser(formatter_class=argparse.RawDescriptionHelpFormatter,
                                     description=DESCRIPTION)
    parser.add_argument('-ue', '--use_entrez', action='store_true',
                        help="input file uses entrez IDs instead of RefSeq")
    parser.add_argument('-t', '--tmpdir', default='tmp',
                        help="temporary directory")
    parser.add_argument('-pd', '--preddir', default='TargetPredictionDatabases',
                        help="target prediction directory")
    parser.add_argument('-mf', '--maturefa', default='common/mature.fa.gz',
                        help="path to mature.fa file")
    parser.add_argument('g2refseq', help="path to gene2refseq.gz file")
    parser.add_argument('expdir', help='expression input directory')
    parser.add_argument('mirvscores', help='mirvestigator scores CSV file')
    parser.add_argument('outdir', help='output directory')
    args = parser.parse_args()

    if not os.path.exists(args.outdir):
        os.makedirs(args.outdir)
    if not os.path.exists(args.tmpdir):
        os.makedirs(args.tmpdir)

    refSeq2entrez = firm.make_refseq2entrez(args.g2refseq)
    firm.run_target_prediction_dbs(refSeq2entrez,
                                   exp_dir=args.expdir,
                                   outdir=args.outdir,
                                   tmpdir=args.tmpdir,
                                   pred_db_dir=args.preddir,
                                   use_entrez=args.use_entrez)

    firm.write_combined_report(args.mirvscores, args.maturefa,
                               outdir=args.outdir)
